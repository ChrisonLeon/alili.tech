---
title: 'Taro跨端开发之依赖管理的困扰'
tags: [Taro,跨端开发,前端架构]
slug: h8gasmt9u5c
keywords: Taro,多端同构,前端架构,多端开发技巧,跨端开发
date: 2020-08-20 22:17:36
---

## 长期迭代的项目稳定问题

我们在开发周期比较长的前端项目的时候,必然会遇到依赖管理的问题.

我们在开发项目的时候,我们用了大量的三方库.这些三方的依赖库时不时的会更新自己的代码.

第三方依赖库的代码更新会很容易造成代码运行的不稳定,

比如昨天还跑的好好的项目,另一位刚刚接手的同学重新安装依赖之后项目就完全跑不起来了.

或者自己机器跑的好好的代码,扔到打包机上重新打包之后就完全跑不起来.

因为三方依赖库用的太多,很多时候并不能很快速的定位到项目为什么跑不起来.

特别是开发RN项目的时候,一个依赖更新的问题可能会定位一个大半天才能找到罪魁祸首(曾经的我为了这种事情浪费了大量的青春).


## 锁定NPM依赖版本

对于那些你不熟悉,或者不能保证稳定的三方npm包,我这边的做法是`直接锁定版本号`.

这件事情做的越早越好,不要盲目相信三方npm越更新性能越好.

他会时不时的让你痛一下.让你浪费大量的时间去寻找到底是谁影响了你的代码正常运行.


## 第三方npm包有bug如何解决?

### 升级原有npm包版本
如果你发现了你的第三方npm有bug,建议不要盲目的升级版本.

第一步你需要先看这个npm包的 `changelog`,如果有明确修复过这个bug,

才会建议你升级.但是不能保证升级之后可能会带来其他bug.

### 修掉bug发布在公司私有源

但是我还是比较建议,在原来版本的npm包上修掉这个bug,并且修改npm包名为公司内部包,发布到公司私有npm源上. 

如果因为npm版本的改动,导致项目不稳定,也可以缩小排查范围,快速定位到是哪一个npm库导致的问题.

例如: mobx => @公司源/mobx


### 小技巧: .npmrc配置
如果你有发布到公司私有源的三方npm包,

你可以尝试修改.npmrc文件使用npm名的作用域直接指向公司私有源

例如:

```
@公司源:registry=http://npm.xxx.com
@tarojs:registry=http://npm.xxx.com
```



## 所有项目依赖统一管理

### 核心依赖集中管理

上面说到了我们将所有的有不稳定的npm包锁定版本,保证项目长期维护可以正常运行.

现在我们团队开发的跨端项目将近上百个. 为了保证上百个的项目可以长期稳定运行.

我将所有的依赖封装成了一个`npm库`,里面没有任何的js代码,只有稳定的依赖.

所有的项目都会引入这个核心的依赖,以保证所有项目可以稳定运行.


### 非核心依赖版本管理问题

如果是非核心依赖,我们将使用我们自研的`cli`工具强行修改package.json里面的版本号.

因为在持续集成的过程中,这个cli工具总是会在`npm install`之前做一些版本差异抹平等工作.

因为这个cli工具,我们对所有的项目有了极大的可控性.能保证所有的项目的依赖,都是我们最新指定的版本.


### 保证项目使用npm的差异化,强行指定版本

所有依赖全部统一之后,肯定会有项目因为一些原因不想使用个别的三方npm包.

这里就必须要提到`package.json`依赖管理的 `resolutions`属性.

`resolutions` 字段用于解析选择性版本，可以通过此功能自定义依赖版本。 

这样npm就会将多版本共存的版本,强行指定某一版本,满足个别项目的特定需求.

![图 1](https://incomparable9527.coding.net/p/imageBed/d/imageBed/git/raw/master/0a9ce7a425c583573c877efd0ce648a9c3992b90d4f272621a3850afa523cfa3.png)  

如果我要所有的 `B` 强行指定2.0

使用方法如下:

```json
// package.json 
// 这样B这个依赖库,就被强行指定版本了
{
    "resolutions": {
        "B": "2.0.0"
    }
}
```

resolutions的解释,你可以在这里查看更多:

https://classic.yarnpkg.com/zh-Hans/docs/selective-version-resolutions

当然你也可以使用这个工具,将依赖强制指定版本:

https://www.npmjs.com/package/npm-force-resolutions

## 版本变更后的开发环境和生产环境

如果你目前版本变更的比较频繁的话,

很容易产生版本变更后两个环境的不一致,很有可能会产生一些微妙的问题.

在这里我还是建议: 每次升级后还是完全的删除 `node_modules` 目录,重新安装依赖.特别是在打包机上.

安装依赖的实践,相对你排查莫名其妙的问题的实践,其实是`赚的`. 

当然,这只是在版本变更比较频繁的情况下,如果开始组件稳定,

打包机上还是建议开始缓存依赖,这样可以减少大量日常开发时间.




## 加速你的npm安装速度

除了大家都知道的npm换源之外,npm依赖的执行文件下载也会拖慢你的依赖安装速度.

以下是我们团队使用的`.npmrc`配置,对于一些npm依赖的执行文件,
可以使用该配置加速你的npm构建速度.

> .npmrc文件的位置在你的home目录下,你也可以在项目根目录创建该文件.

```
chromedriver-cdnurl=https://npm.taobao.org/mirrors/chromedriver
couchbase-binary-host-mirror=https://npm.taobao.org/mirrors/couchbase/v{version}
debug-binary-host-mirror=https://npm.taobao.org/mirrors/node-inspector
electron-mirror=https://npm.taobao.org/mirrors/electron/
flow-bin-binary-host-mirror=https://npm.taobao.org/mirrors/flow/v
fse-binary-host-mirror=https://npm.taobao.org/mirrors/fsevents
fuse-bindings-binary-host-mirror=https://npm.taobao.org/mirrors/fuse-bindings/v{version}
git4win-mirror=https://npm.taobao.org/mirrors/git-for-windows
gl-binary-host-mirror=https://npm.taobao.org/mirrors/gl/v{version}
grpc-node-binary-host-mirror=https://npm.taobao.org/mirrors
hackrf-binary-host-mirror=https://npm.taobao.org/mirrors/hackrf/v{version}
leveldown-binary-host-mirror=https://npm.taobao.org/mirrors/leveldown/v{version}
leveldown-hyper-binary-host-mirror=https://npm.taobao.org/mirrors/leveldown-hyper/v{version}
mknod-binary-host-mirror=https://npm.taobao.org/mirrors/mknod/v{version}
node-sqlite3-binary-host-mirror=https://npm.taobao.org/mirrors
node-tk5-binary-host-mirror=https://npm.taobao.org/mirrors/node-tk5/v{version}
nodegit-binary-host-mirror=https://npm.taobao.org/mirrors/nodegit/v{version}/
operadriver-cdnurl=https://npm.taobao.org/mirrors/operadriver
phantomjs-cdnurl=https://npm.taobao.org/mirrors/phantomjs
profiler-binary-host-mirror=https://npm.taobao.org/mirrors/node-inspector/
puppeteer-download-host=https://npm.taobao.org/mirrors
python-mirror=https://npm.taobao.org/mirrors/python
rabin-binary-host-mirror=https://npm.taobao.org/mirrors/rabin/v{version}
sass-binary-site=https://npm.taobao.org/mirrors/node-sass
sodium-prebuilt-binary-host-mirror=https://npm.taobao.org/mirrors/sodium-prebuilt/v{version}
sqlite3-binary-site=https://npm.taobao.org/mirrors/sqlite3
utf-8-validate-binary-host-mirror=https://npm.taobao.org/mirrors/utf-8-validate/v{version}
utp-native-binary-host-mirror=https://npm.taobao.org/mirrors/utp-native/v{version}
zmq-prebuilt-binary-host-mirror=https://npm.taobao.org/mirrors/zmq-prebuilt/v{version}
sentrycli_cdnurl=https://npm.taobao.org/mirrors/sentry-cli
```









